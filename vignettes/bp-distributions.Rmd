--- title: "Pediatric Blood Pressure Distributions" output:
rmarkdown::html_vignette: toc: true number_sections: true bibliography:
references.bib vignette: > %\VignetteIndexEntry{Pediatric Blood Pressure
Distributions} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---


```{r label = "setup", include = FALSE}
knitr::opts_chunk$set( collapse = TRUE , fig.align = "center")
library(pedbp)
```


# Introduction

Part of the work of @martin2022machine required transforming blood
pressurement measurement into percentiles based on published norms.  This
work was complicated by the fact that data for pediatric blood pressure
precentiles is sparse and gennerally only applicable to children at least one
year of age and requires height, a commonly unavailable data point in
electronic health records for a variety of reasons.

A solution to building pediatric blood pressure percentiles was developed and
is presented here for others to use.  Inputs for the developed method are:

1. Patient sex (male/female) _required_ 2. Systolic blood pressure (mmHg)
_required_ 3. Diastolic blood pressure (mmHg) _required_ 4. Patient height
(cm) _if known_.

Given the inputs the following logic is used to determine which data sets
will be used to inform the blood pressure percentiles.  Under one year of
age, the data from @gemelli1990longitudinal will be used; height is
irrelevent.  For those at least one year of age with a known height then the
@nhlbi data sets are used.  If height is unknown and age is at least three
years then data from @lo2013prehypertension is used.  Lastly, under three
years of age with unknown height have blood pressure precentiles estimated by
the @nhlbi data with the default of the median height for sex and age.

![](./flowchart.png)

# Estimating Pediatric Blood Distributions

There are two functions provided for working with blood pressure
distributions.  These methods uses Gausssian distributions for both systolic
and diastolic blood pressures with means and standard deviations either
explicitly from a aformentioned source or derived by optimizing the paramters
such that the sum of squared errors between the provided quantiles from a
aformentioned source and the distribution quantiles is minimized.  The
provided functions, a distribuiton function and a qunatile function, follow a
similar naming convention to the distribution functions found the stats
library in R.


```{r Distribution Function}
args(p_bp)

# Quantile Function
args(q_bp)
```



Both methods expect age in months, and an indicator for sex.  If height is
missing, e.g., NA, then the default higher percentile of 50 will will be used
as applicable.  The end user may modify the the default height percentile.

If height is entered, then the height percentile is determined via a LMS
method for age and sex and corresponding LMS data from the Centers for Disease Control and
Preventions (more infomation on LMS methods and data later in this vignette.)
The parameters for the blood pressure distriution are found in a look up
table using the nearest age and height percentile.

## Percentiles


```{r }
p_bp(q_sbp = 100, q_dbp = 60, age = 44.5, male = 1)
p_bp(q_sbp = 100, q_dbp = 60, age = 44.5, male = 1, height = 183)
```


# Source Data Sets

Provided data sets have been processed to have the same names and units.

* age: numeric value in months
* male: integer value, 1 = male, 0 = female
* sbp : systolic blood pressure, mmHg
* dbp : diastolic blood pressure, mmHg
* height: numberic value in cm

Summary statistics are prepended, e.g., mean_sbp is the mean systolic blood
pressure.

A listing of the data sets can be found thusly:

```{r }
data(package = "pedbp")$results[, "Item"]
```


## @gemelli1990longitudinal

Used for patients under one year of age.


```{r }
data(gemelli1990, package = "pedbp")
str(gemelli1990)
```


## @lo2013prehypertension


```{r }
data(lo2013, package = "pedbp")
str(lo2013)
```


# Estimated Distributions

Given that the provided data is a mixture of percentiles and means with
standard deviations we opted to approximate all the distributions for height
and blood pressure as Gausssians.  For example, the function est_norm will
find the mean and standard deviation needed to define a normal random
variable with quantiles similar to the ones provided.

For $$X \sim N\left(\mu, \sigma\right)$$ we estimate the mean, $\mu,$ and
standard deviation, $\sigma,$ given a vector of quantiles, $q,$ and the
corresponding probabilties, $p,$ such that $$\Pr\left(X \leq q\right) = p.$$

Note: The est_norm function allows the end user to select weights to
emphasize particular quantiles to fit.  The default setting is to weight all
quantiles equally.

# PLOTS


```{r }
# when no height
d <- data.table::CJ(male = 0:1
                    , age = unique(bp_parameters$age)#seq(3, 18 * 12, by = 1)
                    , bp_percentile = c(5, 10, 25, 50, 75, 90, 95) / 100)

d <- d[, as.list(q_bp(bp_percentile, bp_percentile, age, male))
       , by = .(male, age, bp_percentile)]

d <- data.table::melt(d
                      , id.vars = c("male", "age", "bp_percentile")
                      , measure.vars = c("sbp", "dbp")
                      )

ggplot2::ggplot(d) +
  ggplot2::aes(x = age, y = value, linetype = variable, color = factor(bp_percentile)) +
  # ggplot2::geom_line() +
  ggplot2::geom_smooth(se = FALSE) +
  ggplot2::facet_grid( ~ male) +
  ggplot2::scale_y_continuous(breaks=c(30,60, 90, 120), limits = c(28, 140))

#ggplot2::ggplot(cdc_bp_norms





# no_ht_b_plot <-
#   ggplot2::ggplot(no_ht_all_b_both, ggplot2::aes(x = age, y = bp, col = group)) +
#   ggplot2::geom_smooth(se = FALSE) +
#   ggrepel::geom_label_repel(ggplot2::aes(label = label), size = 3, nudge_x = 1, nudge_y = 1, na.rm = TRUE) +
#   ggplot2::labs(title = "Blood Pressure Percentiles: Boys", tag = 'A', y = "Blood Pressure (mmHg)", x = "Age (yr)") +
#   ggplot2::scale_y_continuous(breaks=c(30,60, 90, 120), limits = c(28, 140)) +
#   ggplot2::theme(
#                  plot.title = ggplot2::element_text(size = 16, face = "bold"),
#                  axis.text = ggplot2::element_text(size = 14, face = "bold"),
#                  axis.title = ggplot2::element_text(size = 16, face = "bold"),
#                  legend.position = "none") +
#   ggplot2::scale_x_continuous(breaks=c(1,5, 10, 15), limits = c(0.0833333, 17.1))
```





# References
<div id="refs"></div>

# Session Info

```{r label = "sessioninfo"}
sessionInfo()
```

